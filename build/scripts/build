#!/usr/bin/env bash
PROJECT=go-tutorial
DOCKERIMG=thednp/go-tutorial
TUTORIALNB=notebooks/GolangTutorial.ipynb
GOPHERHOME=./$PROJECT.d
GOPHERWORKSPACE=$GOPHERHOME/.jupyter/lab/workspaces
BUILDWORKSPACE=build/config/home.jupyter.lab/workspaces
VERSION=$(date +v%y.%j.%H%M)

build () { 
  echo $VERSION > VERSION
  docker build -f build/Dockerfile -t $DOCKERIMG:$VERSION -t $DOCKERIMG:latest .
  rm VERSION
  [ -n "$KEEPLOG" ] && echo $DOCKERIMG:$VERSION > $KEEPLOG
}

storeNotebook () {
  command -v jq >&/dev/null \
    && [ -e $GOPHERHOME/$TUTORIALNB ] \
      && cat $GOPHERHOME/$TUTORIALNB \
         | jq '.cells[] |= del(.outputs,.execution_count)' | tee $TUTORIALNB
}

storeWorkspaceSettings () {
  ls -1t $GOPHERWORKSPACE/default* | tail -1 \
      | xargs cat | tee $BUILDWORKSPACE/default*
}

store () {
  storeNotebook
  storeWorkspaceSettings
}

store
build
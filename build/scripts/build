#!/usr/bin/env bash
PROJECT=go-tutorial
DOCKERIMG=thednp/go-tutorial
DOCKERIMGDEPR=thednp/gotutorial
DOCKERCACHE=$DOCKERIMG-cache
TUTORIALNB=notebooks/GolangTutorial.ipynb
GOPHERHOME=./$PROJECT.d
GOPHERWORKSPACE=$GOPHERHOME/.jupyter/lab/workspaces
BUILDWORKSPACE=build/config/home.jupyter.lab/workspaces
VERSION=$(date +v%y.%j.%H%M)
set -x
build () { 
  [[ "$1" =~ ^all|deprecated$ ]] && {
    docker build -f build/Dockerfile.obsolete -t $DOCKERIMGDEPR:latest .
    [ -n "$KEEPLOG" ] && echo $DOCKERIMGDEPR:latest >> $KEEPLOG
  }
  ! [[ "$1" =~ ^deprecated$ ]] && {
    echo $VERSION > VERSION
    if [ "$2" == "buildx" ] ; then
      docker buildx create --use --driver=docker-container
      docker buildx build \
          --cache-from "type=registry,ref=$DOCKERCACHE" \
          --cache-to "type=registry,ref=$DOCKERCACHE" \
          --output "type=image, name=$DOCKERIMG:latest,push=false" \
          -f build/Dockerfile .
      [[ "$1" =~ "^all|version$" ]] && docker tag $DOCKERIMG:latest $DOCKERIMG:$VERSION
    else
      docker build -f build/Dockerfile  -t $DOCKERIMG:latest \
        $([ -n "$1" ] && echo -t $DOCKERIMG:$VERSION || echo -n "") .
    fi
    rm VERSION
    [ -z "$KEEPLOG" ] || {
      echo $DOCKERIMG:$VERSION >> $KEEPLOG
      echo $DOCKERIMG:latest   >> $KEEPLOG
    }
  }
}

storeNotebook () {
  command -v jq >&/dev/null \
    && [ -e $GOPHERHOME/$TUTORIALNB ] \
      && cat $GOPHERHOME/$TUTORIALNB \
         | jq '.cells[] |= del(.outputs,.execution_count)' | tee $TUTORIALNB >&/dev/null
}

storeWorkspaceSettings () {
  ls -1t $GOPHERWORKSPACE/default* >&/dev/null | tail -1 \
      | xargs cat | tee $BUILDWORKSPACE/default* >&/dev/null
}

store () {
  storeNotebook
  storeWorkspaceSettings
}

[ -n "$1" ] \
  && ! { [[ "$1" =~ ^deprecated$       ]] && [ -z "$2" ] ; } \
  && ! { [[ "$1" =~ ^all|with-version$ ]] && [[ "$2" =~ ^buildx$ ]] ; } \
  && echo "\
Usage: $0 [all|deprecated|with-version] [buildx]

  all          [buildx]  build also deprecated image
  with-version [buildx]  build main image also with version tag
  deprecated             build deprecated image only
  buildx                 use registry cache
" && exit 1

store
build "$@"